---
name: Publish - Ruby Gem

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish (e.g., v0.4.0)'
        required: true
        type: string
        default: 'latest'
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  actions: write
  id-token: write

concurrency:
  group: publish-gem-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sbom:
    name: ðŸ“‹ Generate & Sign SBOM
    # Uses trust-and-skip pattern: tag already validated in PR workflow
    uses: ./.github/workflows/reusable-sbom.yml
    permissions:
      contents: read
      actions: write
      id-token: write

  build:
    name: ðŸ”¨ Build Gem Package
    needs: [sbom]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 20
    permissions:
      contents: read
    outputs:
      gem-version: ${{ steps.gem-info.outputs.version }}
      gem-name: ${{ steps.gem-info.outputs.name }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            pkg-containers.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            pipelines.actions.githubusercontent.com:443
            registry.npmjs.org:443
            npmjs.org:443
            bun.sh:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate version sync
        run: ./scripts/ci/validate-version-sync.sh

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version: '1.3.8'

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'

      - name: Setup Ruby
        uses: ruby/setup-ruby@8d27f39a5e7ad39aebbcbd1324f7af020229645c # v1.287.0
        with:
          ruby-version: '4.0.0'
          bundler-cache: true

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build npm package
        run: bun run build

      - name: Build theme CSS files
        run: bun run build:themes

      - name: Build gem package
        run: bun run build:gem

      - name: Extract gem information
        id: gem-info
        run: ./scripts/ci/extract-gem-info.sh

      - name: Verify gem package
        run: ./scripts/ci/verify-gem-package.sh ${{ steps.gem-info.outputs.path }}

      - name: Run tests against built package
        run: bun run test

      - name: Generate SHA256 checksum
        id: checksum
        run: ./scripts/ci/generate-checksum.sh ${{ steps.gem-info.outputs.path }}

      - name: Upload gem artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: gem-package-${{ steps.gem-info.outputs.version }}
          path: ${{ steps.gem-info.outputs.path }}
          retention-days: 90
          if-no-files-found: error

      - name: Build summary
        run: ./scripts/ci/build-summary.sh "${{ steps.gem-info.outputs.name }}" "${{ steps.gem-info.outputs.version }}" "${{ steps.checksum.outputs.sha256 }}"

  publish:
    name: ðŸ“¦ Publish to RubyGems
    needs: [build]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 10
    permissions:
      contents: read
      id-token: write
    environment:
      name: rubygems
      url: https://rubygems.org/gems/turbo-themes
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            objects.githubusercontent.com:443
            pkg-containers.githubusercontent.com:443
            codeload.github.com:443
            release-assets.githubusercontent.com:443
            cache.ruby-lang.org:443
            rubygems-downloads.global.ssl.fastly.net:443
            rubygems.org:443
            api.rubygems.org:443
            index.rubygems.org:443
            bundler.rubygems.org:443
            rubygems.global.ssl.fastly.net:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download gem artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: gem-package-${{ needs.build.outputs.gem-version }}
          path: .

      - name: Verify artifact integrity
        run: ./scripts/ci/verify-artifact.sh

      - name: Setup Ruby
        uses: ruby/setup-ruby@8d27f39a5e7ad39aebbcbd1324f7af020229645c # v1.287.0
        with:
          ruby-version: '4.0.0'

      - name: Configure RubyGems credentials
        uses: rubygems/configure-rubygems-credentials@bc6dd217f8a4f919d6835fcfefd470ef821f5c44 # v1.0.0
        with:
          role-to-assume: ${{ secrets.RUBYGEMS_OIDC_ROLE }}

      - name: Publish to RubyGems
        run: ./scripts/ci/publish-gem.sh

      - name: Summary
        run: ./scripts/ci/publish-summary.sh "${{ needs.build.outputs.gem-version }}" "${{ needs.build.outputs.gem-name }}"
